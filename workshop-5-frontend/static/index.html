<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emanon | Social Media Command</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'display': ['Outfit', 'sans-serif'],
                        'mono': ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        'void': '#0a0a0f',
                        'surface': '#12121a',
                        'surface-2': '#1a1a24',
                        'surface-3': '#22222e',
                        'edge': '#2a2a38',
                        'muted': '#6b6b80',
                        'amber': {
                            400: '#fbbf24',
                            500: '#f59e0b',
                        },
                        'emerald': {
                            400: '#34d399',
                            500: '#10b981',
                        },
                        'rose': {
                            400: '#fb7185',
                            500: '#f43f5e',
                        },
                        'violet': {
                            400: '#a78bfa',
                            500: '#8b5cf6',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }

        body {
            background: #0a0a0f;
            background-image:
                radial-gradient(ellipse at 20% 0%, rgba(251, 191, 36, 0.03) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(139, 92, 246, 0.03) 0%, transparent 50%);
        }

        .card {
            background: linear-gradient(135deg, rgba(26, 26, 36, 0.8) 0%, rgba(18, 18, 26, 0.9) 100%);
            border: 1px solid rgba(42, 42, 56, 0.5);
            backdrop-filter: blur(20px);
        }

        .card-glow {
            box-shadow: 0 0 40px -10px rgba(251, 191, 36, 0.1);
        }

        .stat-number {
            background: linear-gradient(135deg, #fff 0%, #a1a1aa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .pending-card {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.05) 0%, rgba(26, 26, 36, 0.9) 100%);
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        .btn-post {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 4px 20px -4px rgba(245, 158, 11, 0.4);
            transition: all 0.2s ease;
        }

        .btn-post:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 24px -4px rgba(245, 158, 11, 0.5);
        }

        .btn-post:active {
            transform: translateY(0);
        }

        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: fadeInUp 0.4s ease-out forwards;
        }

        .delay-1 { animation-delay: 0.05s; opacity: 0; }
        .delay-2 { animation-delay: 0.1s; opacity: 0; }
        .delay-3 { animation-delay: 0.15s; opacity: 0; }
        .delay-4 { animation-delay: 0.2s; opacity: 0; }
        .delay-5 { animation-delay: 0.25s; opacity: 0; }

        .scrollbar-thin::-webkit-scrollbar {
            width: 4px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: transparent;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #2a2a38;
            border-radius: 2px;
        }

        input[type="checkbox"] {
            accent-color: #f59e0b;
        }

        input[type="number"] {
            background: #1a1a24;
            border: 1px solid #2a2a38;
            color: #fff;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #f59e0b;
        }
    </style>
</head>
<body class="min-h-screen font-display text-white antialiased">
    <div x-data="dashboard()" x-init="init()" x-cloak class="max-w-7xl mx-auto px-6 py-8">

        <!-- Header -->
        <header class="mb-10 animate-in">
            <div class="flex items-center justify-between">
                <div>
                    <div class="flex items-center gap-3 mb-1">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-400 to-amber-600 flex items-center justify-center">
                            <svg class="w-5 h-5 text-void" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                        </div>
                        <h1 class="text-2xl font-semibold tracking-tight">Emanon</h1>
                    </div>
                    <p class="text-muted text-sm font-mono">Social Media Command Center</p>
                </div>
                <div class="flex items-center gap-6">
                    <div class="text-right">
                        <p class="text-xs text-muted uppercase tracking-wider">Notion Pages</p>
                        <p class="text-lg font-semibold text-emerald-400" x-text="watcher.current_docs || 0"></p>
                    </div>
                    <div class="w-px h-8 bg-edge"></div>
                    <a href="/logs" class="text-sm text-muted hover:text-white transition-colors">Logs →</a>
                    <a href="/docs" class="text-sm text-muted hover:text-white transition-colors">API Docs →</a>
                </div>
            </div>
        </header>

        <!-- Pending Posts Queue - PROMINENT -->
        <section class="mb-8 animate-in delay-1" x-show="pendingPosts.length > 0">
            <div class="pending-card card-glow rounded-2xl p-6">
                <div class="flex items-center justify-between mb-5">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full bg-amber-400 pulse-dot"></div>
                        <h2 class="text-lg font-semibold">Ready to Post</h2>
                        <span class="px-2 py-0.5 rounded-full bg-amber-500/20 text-amber-400 text-xs font-mono" x-text="pendingPosts.length + ' pending'"></span>
                    </div>
                </div>

                <div class="space-y-3">
                    <template x-for="post in pendingPosts.slice(0, 5)" :key="post.id">
                        <div class="bg-surface/50 rounded-xl p-4 border border-edge/50 hover:border-amber-500/30 transition-colors">
                            <!-- Post Image -->
                            <img
                                x-show="post.image_url"
                                x-bind:src="post.image_url"
                                class="w-full max-w-xs rounded-lg border border-edge mb-3"
                                alt="Post image"
                                @error="$el.style.display='none'"
                            >
                            <p class="text-sm text-gray-300 leading-relaxed mb-3" x-text="post.content"></p>
                            <div class="flex items-center justify-between flex-wrap gap-2">
                                <span class="text-xs text-muted font-mono" x-text="formatDate(post.created_at)"></span>
                                <div class="flex items-center gap-2">
                                    <button
                                        @click="postNow(post.id)"
                                        :disabled="loading"
                                        class="px-3 py-1.5 rounded-lg bg-emerald-500/20 text-emerald-400 text-sm font-medium hover:bg-emerald-500/30 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-1"
                                    >
                                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                                        </svg>
                                        Approve
                                    </button>
                                    <button
                                        @click="rejectPendingPost(post.id)"
                                        :disabled="loading"
                                        class="px-3 py-1.5 rounded-lg bg-rose-500/20 text-rose-400 text-sm font-medium hover:bg-rose-500/30 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-1"
                                    >
                                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                        Reject
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </section>

        <!-- Stats Grid -->
        <section class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="card rounded-2xl p-5 animate-in delay-1">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-xs text-muted uppercase tracking-wider mb-1">Total Posts</p>
                        <p class="text-3xl font-bold stat-number" x-text="stats.total_posts || 0"></p>
                    </div>
                    <div class="w-10 h-10 rounded-xl bg-violet-500/10 flex items-center justify-center">
                        <svg class="w-5 h-5 text-violet-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9.5a2 2 0 00-2-2h-2" />
                        </svg>
                    </div>
                </div>
                <p class="text-xs text-muted mt-3">
                    <span class="text-emerald-400 font-medium" x-text="stats.posted_posts || 0"></span> published
                </p>
            </div>

            <div class="card rounded-2xl p-5 animate-in delay-2">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-xs text-muted uppercase tracking-wider mb-1">Responses</p>
                        <p class="text-3xl font-bold stat-number" x-text="stats.total_responses || 0"></p>
                    </div>
                    <div class="w-10 h-10 rounded-xl bg-emerald-500/10 flex items-center justify-center">
                        <svg class="w-5 h-5 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                    </div>
                </div>
                <p class="text-xs text-muted mt-3">
                    <span class="text-emerald-400 font-medium" x-text="stats.posted_responses || 0"></span> sent
                </p>
            </div>

            <div class="card rounded-2xl p-5 animate-in delay-3">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-xs text-muted uppercase tracking-wider mb-1">Embeddings</p>
                        <p class="text-3xl font-bold stat-number" x-text="stats.total_embeddings || 0"></p>
                    </div>
                    <div class="w-10 h-10 rounded-xl bg-amber-500/10 flex items-center justify-center">
                        <svg class="w-5 h-5 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                    </div>
                </div>
                <p class="text-xs text-muted mt-3">
                    <span class="text-amber-400 font-medium" x-text="stats.business_doc_embeddings || 0"></span> from Notion
                </p>
            </div>

            <div class="card rounded-2xl p-5 animate-in delay-4">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-xs text-muted uppercase tracking-wider mb-1">Replies</p>
                        <p class="text-3xl font-bold stat-number" x-text="stats.total_comment_replies || 0"></p>
                    </div>
                    <div class="w-10 h-10 rounded-xl bg-rose-500/10 flex items-center justify-center">
                        <svg class="w-5 h-5 text-rose-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                        </svg>
                    </div>
                </div>
                <p class="text-xs text-muted mt-3">
                    <span class="text-emerald-400 font-medium" x-text="stats.posted_comment_replies || 0"></span> posted
                </p>
            </div>
        </section>

        <!-- Service Controls -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-8">
            <!-- Notion Watcher -->
            <div class="card rounded-2xl p-6 animate-in delay-2">
                <div class="flex items-center justify-between mb-5">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-violet-500/10 flex items-center justify-center">
                            <svg class="w-4 h-4 text-violet-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                        </div>
                        <h3 class="font-semibold">Notion Watcher</h3>
                    </div>
                    <div class="flex items-center gap-2">
                        <span
                            class="w-2 h-2 rounded-full"
                            :class="watcher.running ? 'bg-emerald-400 pulse-dot' : 'bg-muted'"
                        ></span>
                        <span class="text-xs font-mono" :class="watcher.running ? 'text-emerald-400' : 'text-muted'" x-text="watcher.running ? 'Active' : 'Idle'"></span>
                    </div>
                </div>

                <div class="flex gap-2 mb-5">
                    <button
                        @click="startWatcher()"
                        :disabled="watcher.running || loading"
                        class="flex-1 px-4 py-2.5 rounded-xl bg-emerald-500/10 text-emerald-400 text-sm font-medium hover:bg-emerald-500/20 disabled:opacity-30 disabled:cursor-not-allowed transition-colors"
                    >
                        Start
                    </button>
                    <button
                        @click="stopWatcher()"
                        :disabled="!watcher.running || loading"
                        class="flex-1 px-4 py-2.5 rounded-xl bg-rose-500/10 text-rose-400 text-sm font-medium hover:bg-rose-500/20 disabled:opacity-30 disabled:cursor-not-allowed transition-colors"
                    >
                        Stop
                    </button>
                </div>

                <div class="space-y-3 text-sm">
                    <label class="flex items-center gap-3 text-gray-400 cursor-pointer hover:text-gray-300 transition-colors">
                        <input type="checkbox" x-model="watcherConfig.should_post" class="w-4 h-4 rounded">
                        <span>Auto-post to Mastodon</span>
                    </label>
                    <label class="flex items-center gap-3 text-gray-400 cursor-pointer hover:text-gray-300 transition-colors">
                        <input type="checkbox" x-model="watcherConfig.approve" class="w-4 h-4 rounded">
                        <span>Require Telegram approval</span>
                    </label>
                    <div class="flex items-center gap-3 text-gray-400">
                        <span class="text-muted">Min words:</span>
                        <input type="number" x-model.number="watcherConfig.min_words" class="w-16 px-2 py-1 rounded-lg text-sm">
                    </div>
                </div>

                <div class="mt-5 pt-4 border-t border-edge/50 grid grid-cols-2 gap-4 text-xs">
                    <div>
                        <p class="text-muted mb-0.5">Tracked</p>
                        <p class="font-mono text-gray-300" x-text="watcher.docs_tracked || 0"></p>
                    </div>
                    <div>
                        <p class="text-muted mb-0.5">Changes</p>
                        <p class="font-mono text-gray-300" x-text="watcher.stats?.changes_detected || 0"></p>
                    </div>
                </div>
            </div>

            <!-- Comment Listener -->
            <div class="card rounded-2xl p-6 animate-in delay-3">
                <div class="flex items-center justify-between mb-5">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center">
                            <svg class="w-4 h-4 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" />
                            </svg>
                        </div>
                        <h3 class="font-semibold">Comment Listener</h3>
                    </div>
                    <div class="flex items-center gap-2">
                        <span
                            class="w-2 h-2 rounded-full"
                            :class="comments.running ? 'bg-emerald-400 pulse-dot' : 'bg-muted'"
                        ></span>
                        <span class="text-xs font-mono" :class="comments.running ? 'text-emerald-400' : 'text-muted'" x-text="comments.running ? 'Active' : 'Idle'"></span>
                    </div>
                </div>

                <div class="flex gap-2 mb-5">
                    <button
                        @click="startComments()"
                        :disabled="comments.running || loading"
                        class="flex-1 px-4 py-2.5 rounded-xl bg-emerald-500/10 text-emerald-400 text-sm font-medium hover:bg-emerald-500/20 disabled:opacity-30 disabled:cursor-not-allowed transition-colors"
                    >
                        Start
                    </button>
                    <button
                        @click="stopComments()"
                        :disabled="!comments.running || loading"
                        class="flex-1 px-4 py-2.5 rounded-xl bg-rose-500/10 text-rose-400 text-sm font-medium hover:bg-rose-500/20 disabled:opacity-30 disabled:cursor-not-allowed transition-colors"
                    >
                        Stop
                    </button>
                </div>

                <div class="space-y-3 text-sm">
                    <label class="flex items-center gap-3 text-gray-400 cursor-pointer hover:text-gray-300 transition-colors">
                        <input type="checkbox" x-model="commentsConfig.should_post" class="w-4 h-4 rounded">
                        <span>Auto-reply to comments</span>
                    </label>
                    <div class="flex items-center gap-3 text-gray-400">
                        <span class="text-muted">Poll interval:</span>
                        <input type="number" x-model.number="commentsConfig.poll_interval" class="w-16 px-2 py-1 rounded-lg text-sm">
                        <span class="text-muted">sec</span>
                    </div>
                </div>

                <div class="mt-5 pt-4 border-t border-edge/50 grid grid-cols-2 gap-4 text-xs">
                    <div>
                        <p class="text-muted mb-0.5">Processed</p>
                        <p class="font-mono text-gray-300" x-text="comments.stats?.comments_processed || 0"></p>
                    </div>
                    <div>
                        <p class="text-muted mb-0.5">Replied</p>
                        <p class="font-mono text-gray-300" x-text="comments.stats?.replies_generated || 0"></p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Create Post -->
        <section class="card rounded-2xl p-6 mb-8 animate-in delay-4">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-8 h-8 rounded-lg bg-amber-500/10 flex items-center justify-center">
                    <svg class="w-4 h-4 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                    </svg>
                </div>
                <h3 class="font-semibold">Create Post</h3>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-muted mb-2">Topic or context (optional)</label>
                    <textarea
                        x-model="newPostContext"
                        placeholder="e.g., Write about our latest AI consulting services, or share a tip about prompt engineering..."
                        class="w-full px-4 py-3 rounded-xl bg-surface-2 border border-edge text-gray-200 text-sm placeholder-muted focus:outline-none focus:border-amber-500/50 resize-none"
                        rows="3"
                    ></textarea>
                </div>

                <div class="flex items-center gap-4">
                    <button
                        @click="generatePost()"
                        :disabled="loading"
                        class="btn-post px-6 py-2.5 rounded-xl text-void text-sm font-semibold disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                    >
                        <span x-show="!loading || loadingAction !== 'generate'">Generate Post</span>
                        <span x-show="loading && loadingAction === 'generate'" class="flex items-center gap-2">
                            <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Generating...
                        </span>
                    </button>
                    <label class="flex items-center gap-2 text-sm text-gray-400 cursor-pointer">
                        <input type="checkbox" x-model="generateWithImage" class="w-4 h-4 rounded">
                        <span>Include AI image</span>
                    </label>
                </div>
            </div>

            <!-- Generated Post Preview -->
            <div x-show="generatedPost" x-transition class="mt-5 p-5 rounded-xl bg-surface border border-amber-500/30">
                <div class="flex items-center justify-between mb-3">
                    <p class="text-xs text-amber-400 uppercase tracking-wider font-medium">Review Generated Post</p>
                    <span class="text-xs text-muted font-mono" x-text="generatedPost?.content?.length + ' chars'"></span>
                </div>

                <!-- Image Preview -->
                <img
                    x-show="generatedPost && generatedPost.image_url"
                    x-bind:src="generatedPost?.image_url"
                    class="w-full max-w-xs rounded-lg border border-edge mb-3"
                    alt="Post image"
                    @error="$el.style.display='none'"
                >

                <!-- Post Content -->
                <div class="p-4 rounded-lg bg-surface-2 border border-edge/50 mb-4">
                    <p class="text-sm text-gray-200 leading-relaxed whitespace-pre-wrap" x-text="generatedPost?.content"></p>
                </div>

                <!-- Approve / Reject Buttons -->
                <div class="flex items-center gap-3">
                    <button
                        @click="approvePost()"
                        :disabled="loading"
                        class="flex-1 sm:flex-none px-6 py-2.5 rounded-xl bg-emerald-500/20 text-emerald-400 text-sm font-semibold hover:bg-emerald-500/30 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2"
                    >
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                        </svg>
                        Approve & Post
                    </button>
                    <button
                        @click="rejectPost()"
                        :disabled="loading"
                        class="flex-1 sm:flex-none px-6 py-2.5 rounded-xl bg-rose-500/20 text-rose-400 text-sm font-semibold hover:bg-rose-500/30 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2"
                    >
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                        Reject
                    </button>
                    <button
                        @click="regeneratePost()"
                        :disabled="loading"
                        class="px-4 py-2.5 rounded-xl bg-surface-3 text-gray-400 text-sm font-medium hover:bg-edge hover:text-gray-300 disabled:opacity-50 transition-colors flex items-center gap-2"
                    >
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        Regenerate
                    </button>
                </div>
            </div>
        </section>

        <!-- Quick Actions -->
        <section class="card rounded-2xl p-6 mb-8 animate-in delay-5">
            <h3 class="font-semibold mb-4">Quick Actions</h3>
            <div class="flex flex-wrap gap-2">
                <button
                    @click="initEmbeddings()"
                    :disabled="loading"
                    class="px-4 py-2 rounded-xl bg-surface-3 text-gray-300 text-sm font-medium hover:bg-edge transition-colors disabled:opacity-50"
                >
                    <span x-show="!loading || loadingAction !== 'init'">Init Embeddings</span>
                    <span x-show="loading && loadingAction === 'init'" class="flex items-center gap-2">
                        <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Working...
                    </span>
                </button>
                <button
                    @click="refreshEmbeddings()"
                    :disabled="loading"
                    class="px-4 py-2 rounded-xl bg-surface-3 text-gray-300 text-sm font-medium hover:bg-edge transition-colors disabled:opacity-50"
                >
                    Refresh Embeddings
                </button>
                <button
                    @click="checkDocs()"
                    :disabled="loading"
                    class="px-4 py-2 rounded-xl bg-violet-500/10 text-violet-400 text-sm font-medium hover:bg-violet-500/20 transition-colors disabled:opacity-50"
                >
                    Check Notion
                </button>
                <button
                    @click="resetDocs()"
                    :disabled="loading"
                    class="px-4 py-2 rounded-xl bg-rose-500/10 text-rose-400 text-sm font-medium hover:bg-rose-500/20 transition-colors disabled:opacity-50"
                >
                    Reset State
                </button>
            </div>

            <!-- Toast -->
            <div
                x-show="actionResult"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 translate-y-2"
                x-transition:enter-end="opacity-100 translate-y-0"
                x-transition:leave="transition ease-in duration-150"
                x-transition:leave-start="opacity-100"
                x-transition:leave-end="opacity-0"
                class="mt-4 px-4 py-3 rounded-xl text-sm"
                :class="actionResult?.success ? 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20' : 'bg-rose-500/10 text-rose-400 border border-rose-500/20'"
            >
                <p x-text="actionResult?.message"></p>
            </div>
        </section>

        <!-- Activity Feed -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 animate-in delay-5">
            <!-- Recent Posts -->
            <div class="card rounded-2xl p-6">
                <h3 class="font-semibold mb-4 flex items-center gap-2">
                    <span class="text-violet-400">Recent Posts</span>
                    <span class="text-xs font-mono text-muted" x-text="posts.length + ' total'"></span>
                </h3>
                <div class="space-y-3 max-h-80 overflow-y-auto scrollbar-thin pr-2">
                    <template x-for="post in posts.slice(0, 10)" :key="post.id">
                        <div class="p-3 rounded-xl bg-surface/50 border border-edge/30 hover:border-edge transition-colors">
                            <!-- Post Image Thumbnail -->
                            <img
                                x-show="post.image_url"
                                x-bind:src="post.image_url"
                                class="w-20 h-20 object-cover rounded-lg border border-edge float-right ml-3 mb-2"
                                alt="Post image"
                                @error="$el.style.display='none'"
                            >
                            <p class="text-sm text-gray-300 leading-relaxed line-clamp-2" x-text="post.content"></p>
                            <div class="flex items-center gap-2 mt-2 clear-both">
                                <span
                                    class="text-xs px-2 py-0.5 rounded-full font-medium"
                                    :class="post.posted ? 'bg-emerald-500/10 text-emerald-400' : 'bg-amber-500/10 text-amber-400'"
                                    x-text="post.posted ? 'Published' : 'Draft'"
                                ></span>
                                <span class="text-xs text-muted font-mono" x-text="formatDate(post.created_at)"></span>
                            </div>
                        </div>
                    </template>
                    <p x-show="posts.length === 0" class="text-muted text-sm py-8 text-center">No posts yet</p>
                </div>
            </div>

            <!-- Recent Responses -->
            <div class="card rounded-2xl p-6">
                <h3 class="font-semibold mb-4 flex items-center gap-2">
                    <span class="text-emerald-400">Recent Responses</span>
                    <span class="text-xs font-mono text-muted" x-text="responses.length + ' total'"></span>
                </h3>
                <div class="space-y-3 max-h-80 overflow-y-auto scrollbar-thin pr-2">
                    <template x-for="resp in responses.slice(0, 10)" :key="resp.id">
                        <div class="p-3 rounded-xl bg-surface/50 border border-edge/30 hover:border-edge transition-colors">
                            <p class="text-xs text-muted mb-1 font-mono">@<span x-text="resp.original_post_author"></span></p>
                            <p class="text-sm text-gray-300 leading-relaxed line-clamp-2" x-text="resp.response_text"></p>
                            <div class="flex items-center gap-2 mt-2">
                                <span
                                    class="text-xs px-2 py-0.5 rounded-full font-medium"
                                    :class="resp.posted ? 'bg-emerald-500/10 text-emerald-400' : 'bg-amber-500/10 text-amber-400'"
                                    x-text="resp.posted ? 'Sent' : 'Draft'"
                                ></span>
                                <span class="text-xs text-muted font-mono" x-text="formatDate(resp.created_at)"></span>
                            </div>
                        </div>
                    </template>
                    <p x-show="responses.length === 0" class="text-muted text-sm py-8 text-center">No responses yet</p>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="mt-10 pt-6 border-t border-edge/30 text-center">
            <p class="text-xs text-muted">
                Auto-refreshes every 5s ·
                <span class="text-gray-400">Powered by Notion + RAG</span>
            </p>
        </footer>
    </div>

    <script>
        function dashboard() {
            return {
                stats: {},
                watcher: { running: false, config: {}, stats: {}, docs_tracked: 0, current_docs: 0 },
                comments: { running: false, config: {}, stats: {} },
                posts: [],
                responses: [],
                commentReplies: [],
                loading: false,
                loadingAction: null,
                actionResult: null,
                newPostContext: '',
                generateWithImage: true,
                generatedPost: null,

                watcherConfig: {
                    should_post: false,
                    approve: false,
                    min_words: 50,
                    min_lines: 10
                },
                commentsConfig: {
                    should_post: false,
                    poll_interval: 60
                },

                get pendingPosts() {
                    return this.posts.filter(p => !p.posted);
                },

                init() {
                    this.refresh();
                    setInterval(() => this.refresh(), 5000);
                },

                async refresh() {
                    try {
                        const [statsRes, watcherRes, commentsRes, postsRes, responsesRes, repliesRes] = await Promise.all([
                            fetch('/stats').then(r => r.json()),
                            fetch('/watcher/status').then(r => r.json()),
                            fetch('/comments/status').then(r => r.json()),
                            fetch('/posts').then(r => r.json()),
                            fetch('/responses').then(r => r.json()),
                            fetch('/comments/replies').then(r => r.json())
                        ]);

                        this.stats = statsRes;
                        this.watcher = watcherRes;
                        this.comments = commentsRes;
                        this.posts = postsRes;
                        this.responses = responsesRes;
                        this.commentReplies = repliesRes;

                        if (watcherRes.config) {
                            this.watcherConfig = { ...this.watcherConfig, ...watcherRes.config };
                        }
                        if (commentsRes.config) {
                            this.commentsConfig = { ...this.commentsConfig, ...commentsRes.config };
                        }
                    } catch (e) {
                        console.error('Refresh failed:', e);
                    }
                },

                async postNow(postId) {
                    this.loading = true;
                    try {
                        const res = await fetch(`/posts/${postId}/publish`, { method: 'POST' });
                        if (!res.ok) {
                            const data = await res.json();
                            throw new Error(data.detail || 'Failed to post');
                        }
                        this.showResult(true, 'Approved and posted to Mastodon!');
                        await this.refresh();
                    } catch (e) {
                        this.showResult(false, e.message);
                    }
                    this.loading = false;
                },

                async rejectPendingPost(postId) {
                    this.loading = true;
                    try {
                        const res = await fetch(`/posts/${postId}`, { method: 'DELETE' });
                        if (!res.ok) {
                            const data = await res.json();
                            throw new Error(data.detail || 'Failed to delete');
                        }
                        this.showResult(true, 'Post rejected and deleted');
                        await this.refresh();
                    } catch (e) {
                        this.showResult(false, e.message);
                    }
                    this.loading = false;
                },

                async generatePost() {
                    this.loading = true;
                    this.loadingAction = 'generate';
                    this.generatedPost = null;
                    try {
                        const res = await fetch('/posts/generate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                context: this.newPostContext,
                                generate_image: this.generateWithImage
                            })
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.detail || 'Failed to generate');
                        this.generatedPost = data;
                        this.showResult(true, 'Post generated! Review and publish below.');
                        await this.refresh();
                    } catch (e) {
                        this.showResult(false, e.message);
                    }
                    this.loading = false;
                    this.loadingAction = null;
                },

                async approvePost() {
                    if (!this.generatedPost?.id) return;
                    this.loading = true;
                    try {
                        const res = await fetch(`/posts/${this.generatedPost.id}/publish`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ image_url: this.generatedPost.image_url })
                        });
                        if (!res.ok) {
                            const data = await res.json();
                            throw new Error(data.detail || 'Failed to post');
                        }
                        this.showResult(true, 'Approved and posted to Mastodon!');
                        this.generatedPost = null;
                        this.newPostContext = '';
                        await this.refresh();
                    } catch (e) {
                        this.showResult(false, e.message);
                    }
                    this.loading = false;
                },

                async rejectPost() {
                    if (!this.generatedPost?.id) return;
                    this.loading = true;
                    try {
                        // Delete the rejected post from database
                        const res = await fetch(`/posts/${this.generatedPost.id}`, {
                            method: 'DELETE'
                        });
                        if (!res.ok) {
                            const data = await res.json();
                            throw new Error(data.detail || 'Failed to delete');
                        }
                        this.showResult(true, 'Post rejected and deleted');
                        this.generatedPost = null;
                        await this.refresh();
                    } catch (e) {
                        this.showResult(false, e.message);
                    }
                    this.loading = false;
                },

                async regeneratePost() {
                    // Delete old post first if exists
                    if (this.generatedPost?.id) {
                        try {
                            await fetch(`/posts/${this.generatedPost.id}`, { method: 'DELETE' });
                        } catch (e) {
                            console.log('Could not delete old post:', e);
                        }
                    }
                    this.generatedPost = null;
                    // Generate new one with same context
                    await this.generatePost();
                },

                async startWatcher() {
                    this.loading = true;
                    try {
                        const res = await fetch('/watcher/start', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.watcherConfig)
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.detail);
                        this.showResult(true, 'Watcher started');
                        await this.refresh();
                    } catch (e) {
                        this.showResult(false, e.message);
                    }
                    this.loading = false;
                },

                async stopWatcher() {
                    this.loading = true;
                    try {
                        const res = await fetch('/watcher/stop', { method: 'POST' });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.detail);
                        this.showResult(true, 'Watcher stopped');
                        await this.refresh();
                    } catch (e) {
                        this.showResult(false, e.message);
                    }
                    this.loading = false;
                },

                async startComments() {
                    this.loading = true;
                    try {
                        const res = await fetch('/comments/start', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.commentsConfig)
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.detail);
                        this.showResult(true, 'Comment listener started');
                        await this.refresh();
                    } catch (e) {
                        this.showResult(false, e.message);
                    }
                    this.loading = false;
                },

                async stopComments() {
                    this.loading = true;
                    try {
                        const res = await fetch('/comments/stop', { method: 'POST' });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.detail);
                        this.showResult(true, 'Comment listener stopped');
                        await this.refresh();
                    } catch (e) {
                        this.showResult(false, e.message);
                    }
                    this.loading = false;
                },

                async initEmbeddings() {
                    this.loading = true;
                    this.loadingAction = 'init';
                    try {
                        const res = await fetch('/embeddings/init', { method: 'POST' });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.detail);
                        this.showResult(true, `Embeddings initialized: ${data.stats.total} total`);
                        await this.refresh();
                    } catch (e) {
                        this.showResult(false, e.message);
                    }
                    this.loading = false;
                    this.loadingAction = null;
                },

                async refreshEmbeddings() {
                    this.loading = true;
                    this.loadingAction = 'refresh';
                    try {
                        const res = await fetch('/embeddings/refresh', { method: 'POST' });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.detail);
                        this.showResult(true, `Embeddings refreshed: ${data.stats.total} total`);
                        await this.refresh();
                    } catch (e) {
                        this.showResult(false, e.message);
                    }
                    this.loading = false;
                    this.loadingAction = null;
                },

                async checkDocs() {
                    this.loading = true;
                    try {
                        const res = await fetch('/watcher/check', { method: 'POST' });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.detail);
                        const msg = data.has_changes
                            ? `Changes detected! ${data.changes.added?.length || 0} added, ${data.changes.modified?.length || 0} modified`
                            : 'No changes detected';
                        this.showResult(true, msg);
                        await this.refresh();
                    } catch (e) {
                        this.showResult(false, e.message);
                    }
                    this.loading = false;
                },

                async resetDocs() {
                    if (!confirm('Reset state? All Notion pages will be treated as new.')) return;
                    this.loading = true;
                    try {
                        const res = await fetch('/watcher/reset', { method: 'POST' });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.detail);
                        this.showResult(true, 'State reset');
                        await this.refresh();
                    } catch (e) {
                        this.showResult(false, e.message);
                    }
                    this.loading = false;
                },

                showResult(success, message) {
                    this.actionResult = { success, message };
                    setTimeout(() => { this.actionResult = null; }, 4000);
                },

                formatDate(dateStr) {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    const now = new Date();
                    const diff = (now - date) / 1000;

                    if (diff < 60) return 'now';
                    if (diff < 3600) return Math.floor(diff / 60) + 'm';
                    if (diff < 86400) return Math.floor(diff / 3600) + 'h';
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
            }
        }
    </script>
</body>
</html>
